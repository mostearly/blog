{"componentChunkName":"component---src-templates-post-index-tsx","path":"/post/kaifa-yige-zhongduan-dongtai-duohang-shuchu-de-gongju","result":{"data":{"markdownRemark":{"html":"<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 925px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9f0ede7a63ec85674b2d9999ae7cc037/e1596/wallhaven-k9xj71.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.27705627705628%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAUCAwQG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAD/9oADAMBAAIQAxAAAAGzXzs8luJBv//EABoQAAIDAQEAAAAAAAAAAAAAAAABAxETAhD/2gAIAQEAAQUCikV6o15EW/P/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwGq/8QAFhEBAQEAAAAAAAAAAAAAAAAAABES/9oACAECAQE/AYy//8QAFxAAAwEAAAAAAAAAAAAAAAAAACAhMf/aAAgBAQAGPwLSr//EABoQAQEBAQADAAAAAAAAAAAAAAEAESFBUXH/2gAIAQEAAT8hxN127oQPsquyTzPutv/aAAwDAQACAAMAAAAQSA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/EA//xAAYEQACAwAAAAAAAAAAAAAAAAAAARExcf/aAAgBAgEBPxCapmj/xAAZEAEAAwEBAAAAAAAAAAAAAAABABEhMUH/2gAIAQEAAT8QMOVavnkyjlpo2TnTaimIjDXFX2f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/9f0ede7a63ec85674b2d9999ae7cc037/a42d1/wallhaven-k9xj71.webp 231w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/a7d21/wallhaven-k9xj71.webp 463w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/31b98/wallhaven-k9xj71.webp 925w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/5c6e0/wallhaven-k9xj71.webp 1388w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/62ac3/wallhaven-k9xj71.webp 1850w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/8df42/wallhaven-k9xj71.webp 2048w\"\n          sizes=\"(max-width: 925px) 100vw, 925px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/9f0ede7a63ec85674b2d9999ae7cc037/d4da3/wallhaven-k9xj71.jpg 231w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/ecde2/wallhaven-k9xj71.jpg 463w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/0ff56/wallhaven-k9xj71.jpg 925w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/8d810/wallhaven-k9xj71.jpg 1388w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/aa991/wallhaven-k9xj71.jpg 1850w,\n/static/9f0ede7a63ec85674b2d9999ae7cc037/e1596/wallhaven-k9xj71.jpg 2048w\"\n          sizes=\"(max-width: 925px) 100vw, 925px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/9f0ede7a63ec85674b2d9999ae7cc037/0ff56/wallhaven-k9xj71.jpg\"\n          alt=\"wallhaven-k9xj71\"\n          title=\"wallhaven-k9xj71\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">wallhaven-k9xj71</figcaption>\n  </figure></p>\n<p>要开发动态在终端输出就需要用到NodeJS自带的<code class=\"language-text\">readline</code>和<code class=\"language-text\">process.stdout</code></p>\n<p>主要用到<code class=\"language-text\">readline</code>中的<code class=\"language-text\">clearLine</code>、<code class=\"language-text\">moveCursor</code>、<code class=\"language-text\">cursorTo</code>这三个函数和<code class=\"language-text\">process.stdout.write</code>这个输出函数</p>\n<p>仅仅单行动态输出只需要简单的清除目标行然后输出就可以了，多行却很复杂，不知道是不是我想得太复杂了</p>\n<p>现在主要目的是实现一个如下方所展示的打印格式</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Program: xxx\nInitializing</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Program: xxx\nLoading: ▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮                                           ▮ 40%</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Program: xxx\nProcessing: ▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮                                              ▮ 40%</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Program: xxx\nCompleted, Time: 3ms</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>上方的进度条主要是使用字符串重复实现</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">progress</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> pad<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  p <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> columns <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span>columns <span class=\"token operator\">-</span> <span class=\"token number\">8</span> <span class=\"token operator\">-</span> pad\n  <span class=\"token keyword\">const</span> pr <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>columns <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> p<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> v <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">▮</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>pr<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> s <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> columns <span class=\"token operator\">-</span> pr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">▮</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>v<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>s<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">▮  </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">padStart</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">%</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面将用到<code class=\"language-text\">string-width</code>和<code class=\"language-text\">chalk</code>两个npm包，一个计算字符串宽度一个输出颜色，此外由于光标走错一行就会打乱渲染，为了处理这个问题所以需要暂停查看光标所在位置，在异步函数中可以同步一个定时器来实现暂停</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ms<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>要实现动态更新终端上的每行就必需记录每次输出的数据，此外还要有不变的ID、数据所在行和时间，使用<code class=\"language-text\">interface</code>来表示数据结构</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">LogItem</span><span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> Symbol <span class=\"token comment\">// 用Symbol来作为唯一ID</span>\n  index<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token comment\">// 记录当前数据所在行</span>\n  length<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token comment\">// 记录数据的字节数，搭配string-width和process.stdout.columns可以实现换行</span>\n  line<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token comment\">// 用于记录数据存在的换行符</span>\n  renderer<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token comment\">// 第一次渲染和第二次渲染有所差异</span>\n  time<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token comment\">// 记录时间，用于顺序渲染，防止输出混乱</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要实现动态输出主要是控制光标和存储输出数据和计算输出数据中换行符号</p>\n<p>对应源码：<a href=\"https://github.com/piecego/subtitle-translation-tool/blob/master/src/utils/dynamic-terminal.util.ts\" target=\"_blank\" rel=\"noopener\">https://github.com/piecego/subtitle-translation-tool/blob/master/src/utils/dynamic-terminal.util.ts</a></p>","id":"c00a6fd8-3402-52dc-8c44-4bcc8bec8548","fields":{"title":"开发一个终端动态多行输出的工具","tags":["nodejs"],"category":"记录","date":"2020-04-01T14:03:00+08:00","dateModified":"2020-05-06T17:28:57+08:00","slug":"/post/kaifa-yige-zhongduan-dongtai-duohang-shuchu-de-gongju","status":true,"comment":true},"excerpt":"要开发动态在终端输出就需要用到NodeJS…"}},"pageContext":{"slug":"/post/kaifa-yige-zhongduan-dongtai-duohang-shuchu-de-gongju","prev":{"slug":"/post/nodejsreadline-biji-zhongduan-shuchu-bufen","title":"NodeJS readline笔记终端输出部分","date":"2020-03-30T18:40:00+08:00","category":"笔记","tags":["NodeJS"],"type":"post"},"next":{"slug":"/post/shiyong-wsl-anzhuang-nvm","title":"使用WSL安装NVM","date":"2020-05-05T18:48:00+08:00","category":"记录","tags":["debian","nodejs"],"type":"post"}}}}