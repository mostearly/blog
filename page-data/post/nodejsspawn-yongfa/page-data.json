{"componentChunkName":"component---src-templates-post-index-tsx","path":"/post/nodejsspawn-yongfa","result":{"data":{"markdownRemark":{"html":"<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 925px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eb6188e9600332099e3b033db5264a1e/a71c9/wallhaven-zx6xgg.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.41125541125541%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAALiMAAC4jAHM9rsvAAADNElEQVQozw2PbVCTBQCA3+uHd3VxORgwR2NOnDq+isBN+Whwjq9twGQipLCxEzZpWyQBjq/mHCpgKB4ekClHcRUfCZgVyCGaSdl56/CufpRdVOd5wSEdel1ldzzx4/nx/HnuHiFaHsKOyHVkwURJgtgqE6FUrLsyDKMulvO+g/z15/es/hFg+fdbLC/Msrb2BFjh6d/jLC74mBpy825bBVeGjyBslYmJ3iIhZh1t4jZKDckU5e6m0JjG6XYXrTVmboydYuXBtywt3GJ1aX499i//PV3in8eD/DrvY+KSnZEBFxfP2BHkko1Ig59DER5EuSmVc41W/LVWyvZlM9zv5fa1Hs61vs7cZDczI+08ejgHa4v88sMYd6aOcW24hWNvmulus9HltSCkqlXUuEq52NtJa4OL9sYKpoeOc3eyl8DYSQKX/Vw4W80X4x181NvEw5+nWX5wkxtXT3KmpZTjznxqKwyUFGhpcJkR/M02vrs7yqPln1havM/EyHmu9h3lt6/6mP/Qw/zHHm5fOcEn7/s41eTg+ucXmP6sE4/bTLUll7cs2RwqSKOuMo/qshyEevc+Lg+1MzZ0gq+/7KfesRe1Ipz0OAWOvFR8h/R82uPBU7mXNw7ocVnN1LoO4m+qpNNnp9FRQKNNz+RAPT3VJoRiYxLDAw3MTnVx52YfRk00ytCNqMJFJEVG8JI0hBa3hbM1hfw41Ymj2IBu9ysY0jWYMlOw5L1Kh6ecwdNORt85jHAgP4H7gfeYmWjjiDWXzSIRKlkoaqWUuEgJKkkw7v1a7FkJNJfraa4qRK/bibU4E2elCUPmLvbnadd3c5kZ70IozIrnqNPAJb+DJ/c+oKwgA6U0mDh5GImKF8lRK7HnJ6EUv0DCFjkGTQxve2x4fVXU1Vupa6hAtycZXZqawX4fQrJKTqJShlWfQpvTjDY6gpQdm5CHBKHaFIw1ZydRoc/zsjICa0kWu+KjyNHEYzJmUPSakarDxThdRXR0urg+242gDBcTJQ5le5gE0TMbqC1OxWtLR/zsBuKkInTbN6PZJkeXEotWoyIjJQbTHjWZibGUZGuYGfUS+KaXx6v3WFmZ439qLfZWtou1zQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/eb6188e9600332099e3b033db5264a1e/a42d1/wallhaven-zx6xgg.webp 231w,\n/static/eb6188e9600332099e3b033db5264a1e/a7d21/wallhaven-zx6xgg.webp 463w,\n/static/eb6188e9600332099e3b033db5264a1e/31b98/wallhaven-zx6xgg.webp 925w,\n/static/eb6188e9600332099e3b033db5264a1e/5c6e0/wallhaven-zx6xgg.webp 1388w,\n/static/eb6188e9600332099e3b033db5264a1e/62ac3/wallhaven-zx6xgg.webp 1850w,\n/static/eb6188e9600332099e3b033db5264a1e/89a08/wallhaven-zx6xgg.webp 3480w\"\n          sizes=\"(max-width: 925px) 100vw, 925px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/eb6188e9600332099e3b033db5264a1e/6e622/wallhaven-zx6xgg.png 231w,\n/static/eb6188e9600332099e3b033db5264a1e/71ce0/wallhaven-zx6xgg.png 463w,\n/static/eb6188e9600332099e3b033db5264a1e/2a50c/wallhaven-zx6xgg.png 925w,\n/static/eb6188e9600332099e3b033db5264a1e/c1bea/wallhaven-zx6xgg.png 1388w,\n/static/eb6188e9600332099e3b033db5264a1e/ca3c3/wallhaven-zx6xgg.png 1850w,\n/static/eb6188e9600332099e3b033db5264a1e/a71c9/wallhaven-zx6xgg.png 3480w\"\n          sizes=\"(max-width: 925px) 100vw, 925px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/eb6188e9600332099e3b033db5264a1e/2a50c/wallhaven-zx6xgg.png\"\n          alt=\"wallhaven-zx6xgg\"\n          title=\"wallhaven-zx6xgg\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">wallhaven-zx6xgg</figcaption>\n  </figure></p>\n<p>在实现CLI的时候经常会出现调用命令的情况，本文将记录使用<code class=\"language-text\">child_process.spawn</code>时的心得，语法查看Node JS官方文档<a href=\"https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options\" target=\"_blank\" rel=\"noopener\">child_process.spawn</a></p>\n<h2>使用异步还是同步？</h2>\n<p>在编写CLI的时候一般都会使用一些动画，在终端上显示什么转圈圈啊，加载多少多少啊等等，如果使用同步就会导致这些动画卡住，为什么会卡住可以参考<a href=\"https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/\" target=\"_blank\" rel=\"noopener\">https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/</a>这里的说明，所以还是使用异步。</p>\n<p>我只想简单的调用一个命令等它执行完再继续执行JS，又不想使用同步就得使用Promise进行封装一下了</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      command <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\s+(?=(?:\"[^\"]+\"|[^\"])+$)/g</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      options <span class=\"token operator\">=</span> args\n      command <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\s+(?=(?:\"[^\"]+\"|[^\"])+$)/g</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> cmd <span class=\"token operator\">=</span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> command<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> stdout <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n      <span class=\"token keyword\">let</span> stderr <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n      cmd<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>stdout <span class=\"token operator\">+=</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      cmd<span class=\"token punctuation\">.</span>stderr<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>stderr <span class=\"token operator\">+=</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      cmd<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      cmd<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exit'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">code</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>code <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原生spawn是传入参数的，我不想将参数挨个写在数组里所以使用正则将其按空格划分，这里比较麻烦的就是引号的问题，自己苦苦思索半天毫无结果，谷歌一搜立马就出来个<a href=\"https://stackoverflow.com/questions/9577930/regular-expression-to-select-all-whitespace-that-isnt-in-quotes\" target=\"_blank\" rel=\"noopener\">stackoverflow</a>，果然我还是个弟弟...</p>\n<h2>设置Windows CMD的编码</h2>\n<p>在某些情况需要解析终端传递的数据时就需要设置编码，这里指Windows，Windows的终端编码默认是GBK，打印出来就是一堆乱码。在<a href=\"https://ss64.com/nt/chcp.html\" target=\"_blank\" rel=\"noopener\">https://ss64.com/nt/chcp.html</a>我找到了Windows的编码代码，65001就是UTF-8的代码</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">chcp <span class=\"token number\">65001</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">await</span> <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chcp 65001'</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2>管道符</h2>\n<p>在实现TCP检测的时候我使用到了Windows的端口查询语法</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">netstat</span> -ano <span class=\"token operator\">|</span> findstr <span class=\"token string\">\"8080\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>这里用到了管道符，在一堆搜索后面我终于找到了如何使用spawn实现windows的管道符，这里就得拆分命令了，分别是<code class=\"language-text\">netstat -ano</code>打印所有端口信息和<code class=\"language-text\">findstr &quot;8080&quot;</code>搜索字符串</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> netstat <span class=\"token operator\">=</span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'netstat'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'-ano'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> findstr <span class=\"token operator\">=</span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'findstr'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>port<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n   stdio<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>netstat<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">,</span> <span class=\"token string\">'pipe'</span><span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>stderr<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> stdout <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\nfindstr<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>stdout <span class=\"token operator\">+=</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nfindstr<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exit'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","id":"a8660e33-29ca-513e-ac9a-2526414b13f8","fields":{"title":"NodeJS Spawn用法","tags":["NodeJS","JavaScript"],"category":"笔记","date":"2019-08-23T21:24:48+08:00","dateModified":"2019-10-28T16:58:24+08:00","slug":"/post/nodejsspawn-yongfa","status":true,"comment":true},"excerpt":"在实现CLI的时候经常会出现调用命令的情况，本文将记录使用时的心得，语法查看Node JS…"}},"pageContext":{"slug":"/post/nodejsspawn-yongfa","prev":{"slug":"/post/shi-jing-bianqian-sixuwanqian","title":"时境变迁，思绪万千","date":"2019-08-20T02:12:11+08:00","category":"记录","tags":[],"type":"post"},"next":{"slug":"/post/yinle-bofangqi","title":"音乐播放器","date":"2019-08-26T13:52:41+08:00","category":"记录","tags":[],"type":"post"}}}}